name: Nix build
on:
  push:
    branches: ['*','!main']
run-name: Test and build flake
jobs:
  nix-build:
    runs-on: nix
    strategy:
       matrix:
         attribute:
           - nixosConfigurations.zeus.config.system.build.toplevel
           - nixosConfigurations.apollo.config.system.build.toplevel
           - nixosConfigurations.hera.config.system.build.toplevel
           - nixosConfigurations.athene.config.system.build.toplevel
           - nixosConfigurations.hephaistos.config.system.build.toplevel
    steps:
      - name: Set HOME
        run: echo "HOME=$(dirname $(pwd))" >> $GITHUB_ENV
      - uses: actions/checkout@v3
      - name: Configuring remote builders
        run: |
          mkdir -p ~/.config/nix
          cp $(builders-configurator) ~/.config/nix/machines
          echo "builders = @$(pwd)/.config/nix/machines" >> ~/.config/nix/nix.conf
      - run: nix build --log-format bar-with-logs .#${{ matrix.attribute }} -v
      - run: archive-nix-path
  nix-flake-check:
    runs-on: nix
    steps:
      - name: Set HOME
        run: echo "HOME=$(dirname $(pwd))" >> $GITHUB_ENV
      - uses: actions/checkout@v3
      - name: Configuring remote builders
        run: |
          mkdir -p ~/.config/nix
          cp $(builders-configurator) ~/.config/nix/machines
          echo "builders = @$(pwd)/.config/nix/machines" >> ~/.config/nix/nix.conf
      - run: nix flake check --log-format bar-with-logs -v
